<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />
    <link rel="stylesheet" href="css/appointment.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="./script/appointment.js"></script>
    <title>Document</title>
</head>

<body>
    <header class="header">
        <a href="./index.html" class="logo"> <span>SO</span>FIT </a>
    </header>
    <section class="input-part">
        <div id="main_cont">
            <div id="navbar">
                <a href="paticularAppointment.html" id="all_appointment">Toate întâlnirile</a>
            </div>
            <div id="main_body">
                <div>
                    <input id="inputdate" type="date" placeholder="Select the appointment date" />
                </div>
                <div>
                    <select name="slot" id="slot-select">
                        <option value="">--Te rog alege o oră--</option>
                        <!-- Orele vor fi generate dinamic -->
                    </select>
                </div>
                <div>
                    <button id="book_appointment">Rezervă acum</button>
                </div>
            </div>
        </div>
    </section>
    <section class="footer">
        <div class="box-container">
            <div class="box">
                <h3>Apasă aici</h3>
                <a class="links" href="#home">Acasa</a>
                <a class="links" href="#about">Despre noi </a>
                <a class="links" href="#features">features</a>
                <a class="links" href="#pricing">Prețuri</a>
                <a class="links" href="#trainers">Antrenori</a>
            </div>
            <div class="box">
                <h3>Program</h3>
                <p> Luni : <i> 7:00 - 22:30</i> </p>
                <p> Marți : <i> 7:00 - 22:30 </i> </p>
                <p> Miercuri : <i> 7:00 - 22:30 </i> </p>
                <p> Joi : <i> 7:00- 22:30 </i> </p>
                <p> Vineri : <i> 7:00 - 22:30 </i> </p>
                <p> Sambată : <i> 7:00 - 21:30 </i> </p>
                <p> duminica : <i> inchis </i> </p>
            </div>
            <div class="box">
                <h3>Contact</h3>
                <p> <i class="fas fa-phone"></i>0749209355 </p>
                <p> <i class="fas fa-phone"></i> 0748244885</p>
                <p> <i class="fas fa-envelope"></i> sofit@gmail.com </p>
                <p> <i class="fas fa-map"></i> Bucuresti, Romania - 077191 </p>
                <div class="share">
                    <a href="https://www.facebook.com/" target="_blank" class="fab fa-facebook-f"></a>
                    <a href="https://twitter.com/" target="_blank" class="fab fa-twitter"></a>
                    <a href="https://www.pinterest.com/" target="_blank" class="fab fa-pinterest"></a>
                    <a href="https://www.linkedin.com/" target="_blank" class="fab fa-linkedin"></a>
                </div>
            </div>
            <div class="box">
                <h3>Abonează-te pentru noile informații</h3>
                <p> ❤️</p>
                <form action="">
                    <input type="email" name="" class="email" placeholder="tastează-ți email-ul" id="">
                    <input type="submit" value="subscribe" class="btn">
                </form>
            </div>
        </div>
    </section>
</body>
<script type="text/javascript">
    $(function(){
        var dtToday = new Date();
     
        var month = dtToday.getMonth() + 1;
        var day = dtToday.getDate();
        var year = dtToday.getFullYear();
        if(month < 10)
            month = '0' + month.toString();
        if(day < 10)
         day = '0' + day.toString();
        var maxDate = year + '-' + month + '-' + day;
        $('#inputdate').attr('min', maxDate);
    });

    document.getElementById('inputdate').addEventListener('change', updateAvailableSlots);

    function updateAvailableSlots() {
        var date = document.getElementById('inputdate').value;
        var trainerId = getUrlParameter('id');

        if (date && trainerId) {
            // Fetch available slots for the selected date and trainer
            fetch(`${baseUrl}/trainer/${trainerId}/availability?date=${date}`)
                .then(response => response.json())
                .then(data => {
                    var slotSelect = document.getElementById('slot-select');
                    slotSelect.innerHTML = '<option value="">--Te rog alege o oră--</option>';

                    var startHour = 8;
                    var endHour = 17;
                    for (var hour = startHour; hour <= endHour; hour++) {
                        var slot = `${hour}:00 - ${hour + 1}:00`;
                        if (!data.bookedSlots.includes(`${hour}:00 - ${hour + 1}:00`)) {
                            var option = document.createElement('option');
                            option.value = slot;
                            option.text = slot;
                            slotSelect.appendChild(option);
                        }
                    }
                })
                .catch(error => console.error('Error fetching availability:', error));
        }
    }

    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    document.getElementById('book_appointment').addEventListener('click', function() {
        var date = document.getElementById('inputdate').value;
        var slot = document.getElementById('slot-select').value;
        var trainerId = getUrlParameter('id');
        var token = sessionStorage.getItem("token");
        var name = sessionStorage.getItem("name");

        console.log("Date:", date, "Slot:", slot, "Token:", token, "Name:", name, "Trainer ID:", trainerId);

        if (!token) {
            alert("Vă rugăm să vă conectați mai întâi pentru a rezerva o întâlnire!!");
        } else if (date == "" || slot == "") {
            alert("Vă rugăm să completați toate câmpurile");
        } else {
            let obj = {
                trainerId: trainerId,
                bookingDate: date,
                bookingSlot: slot
            };
            bookAnAppointment(obj, token, name);
        }
    });

    async function bookAnAppointment(obj, token, name) {
        try {
            let res = await fetch(`${baseUrl}/booking/create`, {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json',
                    Authorization: `${token}`
                },
                body: JSON.stringify(obj)
            });
            let out = await res.json();
            if (out.msg == "Acest slot nu este disponibil.") {
                alert("Acest slot nu este disponibil.");
            } else if (out.msg == "rezervare nouă creată cu succes") {
                alert(`Hii ${name}, Rezervarea dvs. este confirmată pe ${obj.bookingDate}`);
            } else {
                alert("Ceva nu a funcționat!");
            }
        } catch (error) {
            console.log("err", error);
            alert("Ceva nu a funcționat!");
        }
    }
</script>

</html>
